#!/bin/bash

USB_JFFS_SPEED_W=5
UDPXY_URI="http://192.168.50.1:4022"

add_bash() {
    if [[ ! -f /tmp/profile ]];then
        cat <<EOF >> /tmp/profile
#!/bin/bash

export TIME_STYLE=long-iso
export TERM=xterm
alias vim='vim -u /opt/.vimrc'
alias ll='ls -Al -h --color=auto'
alias wget='wget --no-check-certificate'
alias acme='/koolshare/acme/acme.sh --home /koolshare/acme'

color_my_prompt() {
    local __user_and_host="\[\033[01;32m\]\u@\h"
    local __cur_location="\[\033[01;34m\]\w"
    local __git_branch_color="\[\033[31m\]"
    local __git_branch="\$(git branch 2> /dev/null | grep -e ^* | sed -E  s/^\\\\\\\\\\*\ \(.+\)$/\(\\\\\\\\\\1\)\ /)"
    local __prompt_tail="\[\033[35m\]$"
    local __last_color="\[\033[00m\]"
    export PS1="\$__user_and_host \$__cur_location \$__git_branch_color\$__git_branch\$__prompt_tail\$__last_color "
}
color_my_prompt
EOF
        chmod +x /tmp/profile
    fi
    if [[ -f /tmp/profile && -f /jffs/etc/profile && $(grep -c '/tmp/profile' /jffs/etc/profile) -eq 0 ]];then
        sed -i '/\/tmp\/profile/d' /jffs/etc/profile
        echo "[ -f /tmp/profile ] && . /tmp/profile" >> /jffs/etc/profile
    fi
}

unlock_extensions() {
    sed -i 's/\tdetect_package/\t# detect_package/g' /koolshare/scripts/ks_tar_install.sh
}

unlimit_usb() {
    # unlimit usb2jffs write speed 50MB/s to 10MB/s
    sed -r -i "s/^(W_LIMIT)=(.*)$/\1=${USB_JFFS_SPEED_W}/g" /koolshare/scripts/usb2jffs_config.sh
    sed -r -i "s/^(W_LIMIT)=(.*)$/\1=${USB_JFFS_SPEED_W}/g" /koolshare/scripts/swap_make.sh
}

restart_apps() {
    service restart_httpd
    sleep 1
    curl ${http://192.168.50.1:4022}/restart
}

upgrade_acme() {
    if [ -f /koolshare/acme/acme.sh ];then
        sh /koolshare/acme/acme.sh --home /koolshare/acme --upgrade --auto-upgrade 0
    fi
}

main() {
    add_bash
    unlock_extensions
    unlimit_usb
    restart_apps
}

case $1 in
    add_bash|unlock_extensions|unlimit_usb|restart_apps|upgrade_acme|main)
        eval $1
    ;;
    *)
        echo "Usage: $0 {add_bash|unlock_extensions|unlimit_usb|restart_apps|upgrade_acme}"
        exit 0
    ;;
esac