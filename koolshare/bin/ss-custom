#!/bin/bash

SS_TA="/koolshare/ss/ssconfig.sh /koolshare/ss/rules/dnsmasq.postconf"
update_ss_dns_china_user() {
    target=${1}
    if [[ $(grep -n -A 1 'ss_dns_china_user' ${target} | grep 'kingour_custom' | wc -l) -eq 0 ]];then
        line=$(grep -n -A 1 'ss_dns_china_user' ${target}  | grep -oE "^[0-9]+:" | grep -oE "[0-9]+")
        sed -i "${line}a\       #kingour_custom" ${target}
        let line=line+1
        sed -i "${line}a\       if [[ \$(echo \$ss_dns_china_user | grep ':' | wc -l) -eq 1 ]];then CDN=\$(echo \$ss_dns_china_user|awk -F':' '{print \$1}');DNSC_PORT=\$(echo \$ss_dns_china_user|awk -F':' '{print \$2}');fi" ${target}

    fi
}

_main_() {
    for key in $SS_TA;do
        echo $key
        update_ss_dns_china_user $key
    done
}
_main_
